{% extends "base.html" %}{% load static %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
<!-- Page Header -->
<div class="bg-gray-700 py-10 px-4 relative">
  <div class="container mx-auto text-center">
    <h1 class="text-4xl font-bold text-white mb-2">Booking Layanan</h1>
    <p class="text-white text-lg">Isi formulir di bawah ini untuk reservasi layanan</p>
  </div>
  {% comment %} <i
    class="fas fa-calendar-check absolute top-6 right-8 sm:right-8 text-white opacity-80 text-4xl md:text-5xl section-icon"></i> {% endcomment %}
</div>

<!-- Booking Form Section -->
<section class="py-16">
  <div class="container mx-auto px-4 max-w-4xl">

    <!-- Form Card -->
    <div class="bg-white rounded-xl shadow-lg p-8 card-shadow">
      <form id="bookingForm" method="POST" action="" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Pet Selection -->
        <div class="mb-6">
          <label for="pet" class="form-label">Pilih Peliharaan <span class="text-red-500">*</span></label>
          <div class="select-wrapper">
            <select id="pet" name="id_hewan" class="form-select" required>
              <option value="" disabled selected>-- Pilih Hewan Peliharaan --</option>
              {% for pet in peliharaan %}
              <option value="{{ pet.id_hewan }}">{{ pet.nama_hewan }} ({{ pet.jenis_hewan }})</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Service Type Selection -->
        <div class="mb-6">
          <label for="service-type" class="form-label">Tipe Layanan <span class="text-red-500">*</span></label>
          <div class="select-wrapper">
            <select id="service-type" name="tipe_layanan" class="form-select" required>
              <option value="" disabled selected>-- Pilih Tipe Layanan --</option>
              {% for key, value in tipe_layanan.items %}
              <option value="{{ key }}">{{ value }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Dynamic Service Selection -->
        <div class="mb-6">
          <label for="service" class="form-label">Layanan <span class="text-red-500">*</span></label>
          <div class="select-wrapper">
            <select id="service" name="layanan" class="form-select" required disabled>
              <option value="" disabled selected>-- Pilih Layanan --</option>
            </select>
          </div>
        </div>

        <!-- Date and Time -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label for="booking-date" class="form-label">Tanggal Booking <span class="text-red-500">*</span></label>
            <input type="datetime-local" id="booking-date" name="tanggal" class="form-input" required>
          </div>
          <div>
            <label for="booking-time" class="form-label">Durasi Booking Penitipan <span
                class="text-xs text-gray-500">(Harga x hari)</span><span class="text-red-500">*</span></label>
            <input type="number" id="booking-time" name="durasi" class="form-input" min="1" required disabled
              placeholder="Masukkan durasi dalam hari">
          </div>
        </div>

        <!-- Notes Textarea -->
        <div class="mb-8">
          <label for="notes" class="form-label">Catatan Booking</label>
          <textarea id="notes" name="catatan" class="form-input min-h-[120px] resize-y"
            placeholder="Tuliskan catatan atau kebutuhan khusus untuk layanan Anda..."></textarea>
        </div>
        <!-- Terms and Conditions -->
        <!-- Checkbox Terms -->
        <div class="mb-6">
          <div class="flex items-start">
            <input id="terms" type="checkbox" class="form-checkbox mt-1" required />
            <label for="terms" class="ml-2 text-sm text-gray-600">
              Saya menyetujui
              <a href="#" id="openTerms" class="text-orange-theme hover:underline">
                Syarat & Ketentuan
              </a>
              <span class="text-xs md:text-sm text-red-500 mb-2">(harap baca)</span>
            </label>
          </div>
        </div>

        <!-- Modal -->
        <div id="termsModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-start justify-center overflow-y-auto">
          <div class="bg-white rounded-lg w-full h-screen md:h-auto md:max-w-2xl mx-auto md:mt-10 flex flex-col overflow-hidden"><br><br><br>
            <!-- Body (scrollable) -->
            <div
              class="p-4 overflow-y-auto text-gray-700 text-sm space-y-4 flex-1"
            >
              <h2 class="text-xl font-bold text-gray-800">Syarat dan Ketentuan</h2>
              <p>Ditujukan untuk seluruh pengguna website pemesanan pelayanan petshop.</p>

              <h3 class="font-semibold text-gray-900">Pemesanan</h3>
              <ul class="list-disc pl-6 space-y-1">
                <li>Setiap pemesanan pelayanan akan kami minta kelengkapan data untuk kami proses.</li>
                <li>Pemesanan valid dengan pengisian data & pembayaran <b>DP 25%</b> dari total order.</li>
                <li>Konfirmasi pembayaran DP wajib dilakukan untuk menghindari kelalaian.</li>
                <li>Konfirmasi jadwal akan dikirim via HP atau Email.</li>
                <li>Update/perubahan data pelayanan adalah hak petshop, diinformasikan max 3 jam sebelumnya.</li>
                <li>Jika 6 jam setelah input data tidak bayar booking fee → dianggap batal.</li>
                <li>Pemesanan yang sudah dibayar akan berstatus <b>confirmed</b>.</li>
              </ul>

              <h3 class="font-semibold text-gray-900">Perubahan Pemesanan</h3>
              <ul class="list-disc pl-6 space-y-1">
                <li>Perubahan masa sewa max 1×24 jam sebelumnya.</li>
                <li>Petshop berhak menyetujui atau menolak perubahan.</li>
                <li>Overtime 10% per jam jika lewat waktu tanpa konfirmasi.</li>
                <li>Perubahan jam & alamat max 2 jam sebelumnya.</li>
                <li>Perpanjangan masa pelayanan diinformasikan 1×24 jam.</li>
                <li>Petshop berhak menolak perpanjangan jika slot penuh.</li>
              </ul>

              <h3 class="font-semibold text-gray-900">Pembatalan Pemesanan</h3>
              <ul class="list-disc pl-6 space-y-1">
                <li>Pembatalan dikenakan biaya <b>25%</b> dari total sewa.</li>
                <li>Pembatalan gratis jika dilakukan ≥ 2×24 jam sebelum jadwal.</li>
              </ul>

              <h3 class="font-semibold text-gray-900">Perubahan Harga dan Paket Sewa</h3>
              <ul class="list-disc pl-6 space-y-1">
                <li>Musim libur</li>
                <li>Long weekend</li>
                <li>High & peak season</li>
              </ul>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-200 flex justify-center flex-shrink-0">
              <button
                id="closeTerms"
                class="btn-modern bg-orange-500 hover:bg-orange-600 text-white close-modal" >
                Mengerti
              </button>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
          <button type="submit" class="btn-modern px-8 py-3">
            <i class="fas fa-calendar-check mr-2"></i> Booking Sekarang
          </button>
        </div>
      </form>
    </div>
  </div>
</section>
{% endblock content %}
{% block scriptsheet %}
<script>
  // Dynamic service selection based on service type from Django context
  const serviceTypeSelect = document.getElementById('service-type');
  const serviceSelect = document.getElementById('service');
  const durasiInput = document.getElementById('booking-time');
  const layanan = {{ layanan | safe }};

  // Function to handle service type change
  function handleServiceTypeChange(selectedType) {
    serviceSelect.innerHTML = '<option value="" disabled selected>-- Pilih Layanan --</option>';
    serviceSelect.disabled = false;
    // Durasi hanya aktif untuk penitipan
    if (selectedType === 'sitting') {
      durasiInput.disabled = false;
      durasiInput.required = true;
    } else {
      durasiInput.disabled = true;
      durasiInput.required = false;
      durasiInput.value = '';
    }
    if (selectedType && layanan[selectedType]) {
      layanan[selectedType].forEach(function (item) {
        // Pastikan hanya append jika id dan nama_layanan ada
        if (item.id && item.nama_layanan) {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.nama_layanan + ' (Rp. ' + item.harga + ')';
          serviceSelect.appendChild(option);
        }
      });
    } else {
      serviceSelect.disabled = true;
    }
  }

  // Add event listener for service type change
  serviceTypeSelect.addEventListener('change', function () {
    handleServiceTypeChange(this.value);
  });

  // Parse URL parameters to auto-select service type and service
  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      tipe: params.get('tipe'),
      id: params.get('id')
    };
  }

  // Auto-select based on parameters from context
  document.addEventListener('DOMContentLoaded', function () {
    // Check if we have auto-select parameters from Django context
    const autoTipe = "{{ auto_tipe }}";
    const autoId = "{{ auto_id }}";

    if (autoTipe && autoId) {
      // Set service type
      serviceTypeSelect.value = autoTipe;

      // Trigger change to load services
      handleServiceTypeChange(autoTipe);

      // Wait a short moment to ensure options are loaded
      setTimeout(() => {
        // Find and select the service by ID
        const options = serviceSelect.querySelectorAll('option');
        for (let i = 0; i < options.length; i++) {
          if (options[i].value == autoId) {
            serviceSelect.value = autoId;
            break;
          }
        }
      }, 100);
    }
  });


  const openBtn = document.getElementById("openTerms");
  const modal = document.getElementById("termsModal");
  const closeBtn = document.getElementById("closeTerms");

  openBtn.addEventListener("click", (e) => {
    e.preventDefault();
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden"; // disable scroll background
  });

  closeBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
    document.body.style.overflow = "auto"; // enable scroll background
  });

  // Klik di luar modal (hanya di desktop)
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.add("hidden");
      document.body.style.overflow = "auto";
    }
  });
</script>
{% endblock scriptsheet %}