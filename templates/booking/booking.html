{% extends "base.html" %}{% load static %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
<div class="bg-gray-700 py-10 px-4 relative">
  <div class="container mx-auto text-center">
    <h1 class="text-4xl font-bold text-white mb-2">Booking Layanan</h1>
    <p class="text-white text-lg">Isi formulir di bawah ini untuk reservasi layanan</p>
  </div>
</div>

<section class="py-16">
  <div class="container mx-auto px-4 max-w-4xl">

    <div class="bg-white rounded-xl shadow-lg p-8 card-shadow">
      <form id="bookingForm" method="POST" action="" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="mb-6">
          <label for="id_hewan" class="form-label">Pilih Peliharaan <span class="text-red-500">*</span></label>
          <div class="select-wrapper">
            <select id="id_hewan" name="id_hewan" class="form-select" required>
              <option value="" disabled selected>-- Pilih Hewan Peliharaan --</option>
              {% for pet in peliharaan %}
              <option value="{{ pet.id_hewan }}">{{ pet.nama_hewan }} ({{ pet.jenis_hewan }})</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="mb-6">
          <label for="id_tipe_layanan" class="form-label">Tipe Layanan <span class="text-red-500">*</span></label>
          <div class="select-wrapper">
            <select id="id_tipe_layanan" name="tipe_layanan" class="form-select" required>
              <option value="" disabled selected>-- Pilih Tipe Layanan --</option>
              {% for key, value in tipe_layanan.items %}
              <option value="{{ key }}">{{ value }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="mb-6">
          <label for="id_layanan" class="form-label">Layanan <span class="text-red-500">*</span></label>
          <div class="select-wrapper">
            <select id="id_layanan" name="layanan" class="form-select" required disabled>
              <option value="" disabled selected>-- Pilih Layanan --</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label for="id_tanggal" class="form-label">
              Tanggal Booking <span class="text-red-500">*</span>
              <button type="button" id="openCalendarBtn" class="ml-2 text-orange-theme focus:outline-none">
                <i class="fas fa-calendar-alt text-lg"></i>
              </button>
            </label>
            <input type="text" id="id_tanggal" name="tanggal" class="form-input" required>
            <span id="date-error" class="text-red-500 text-xs mt-1 hidden"></span>
          </div>
          <div>
            <label for="id_durasi" class="form-label">Durasi Booking Penitipan <span
                class="text-xs text-gray-500">(Harga x hari)</span><span class="text-red-500">*</span></label>
            <input type="number" id="id_durasi" name="durasi" class="form-input" min="1" required disabled
              placeholder="Masukkan durasi dalam hari">
          </div>
        </div>
        
        <div id="kapasitas-container" class="mb-6 hidden">
            <p class="form-label">Informasi Ketersediaan</p>
            <p id="kapasitas-info" class="text-sm mt-1"></p>
        </div>

        <div class="mb-8">
          <label for="id_catatan" class="form-label">Catatan Booking</label>
          <textarea id="id_catatan" name="catatan" class="form-input min-h-[120px] resize-y"
            placeholder="Tuliskan catatan atau kebutuhan khusus untuk layanan Anda..."></textarea>
        </div>
        <div class="mb-6">
          <div class="flex items-start">
            <input id="id_terms" type="checkbox" class="form-checkbox mt-1" required />
            <label for="id_terms" class="ml-2 text-sm text-gray-600">
              Saya menyetujui
              <a href="#" id="openTerms" class="text-orange-theme hover:underline">
                Syarat & Ketentuan
              </a>
              <span class="text-xs md:text-sm text-red-500 mb-2">(harap baca)</span>
            </label>
          </div>
        </div>

        <div id="termsModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-start justify-center overflow-y-auto">
          <div class="bg-white rounded-lg w-full h-screen md:h-auto md:max-w-2xl mx-auto md:mt-10 flex flex-col overflow-hidden"><br><br><br>
            <div
              class="p-4 overflow-y-auto text-gray-700 text-sm space-y-4 flex-1"
            >
              <h2 class="text-xl font-bold text-gray-800">Syarat dan Ketentuan</h2>
              <p>Ditujukan untuk seluruh pengguna website pemesanan pelayanan petshop.</p>

              <h3 class="font-semibold text-gray-900">Pemesanan</h3>
              <ul class="list-disc pl-6 space-y-1">
                <li>Setiap pemesanan pelayanan akan kami minta kelengkapan data untuk kami proses.</li>
                <li>Pemesanan valid dengan pengisian data & pembayaran <b>DP 25%</b> dari total order.</li>
                <li>Konfirmasi pembayaran DP wajib dilakukan untuk menghindari kelalaian.</li>
                <li>Konfirmasi jadwal akan dikirim via HP atau Email.</li>
                <li>Update/perubahan data pelayanan adalah hak petshop, diinformasikan max 3 jam sebelumnya.</li>
                <li>Jika 6 jam setelah input data tidak bayar booking fee → dianggap batal.</li>
                <li>Pemesanan yang sudah dibayar akan berstatus <b>confirmed</b>.</li>
              </ul>

              <h3 class="font-semibold text-gray-900">Perubahan Pemesanan</h3>
              <ul class="list-disc pl-6 space-y-1">
                <li>Perubahan masa sewa max 1×24 jam sebelumnya.</li>
                <li>Petshop berhak menyetujui atau menolak perubahan.</li>
                <li>Overtime 10% per jam jika lewat waktu tanpa konfirmasi.</li>
                <li>Perubahan jam & alamat max 2 jam sebelumnya.</li>
                <li>Perpanjangan masa pelayanan diinformasikan 1×24 jam.</li>
                <li>Petshop berhak menolak perpanjangan jika slot penuh.</li>
              </ul>

              <h3 class="font-semibold text-gray-900">Pembatalan Pemesanan</h3>
              <ul class="list-disc pl-6 space-y-1">
                <li>Pembatalan dikenakan biaya <b>25%</b> dari total sewa.</li>
                <li>Pembatalan gratis jika dilakukan ≥ 2×24 jam sebelum jadwal.</li>
              </ul>

              <h3 class="font-semibold text-gray-900">Perubahan Harga dan Paket Sewa</h3>
              <ul class="list-disc pl-6 space-y-1">
                <li>Musim libur</li>
                <li>Long weekend</li>
                <li>High & peak season</li>
              </ul>
            </div>

            <div class="p-4 border-t border-gray-200 flex justify-center flex-shrink-0">
              <button
                id="closeTerms"
                class="btn-modern bg-orange-500 hover:bg-orange-600 text-white close-modal" >
                Mengerti
              </button>
            </div>
          </div>
        </div>
        
        <div class="text-center">
          <button type="submit" class="btn-modern px-8 py-3">
            <i class="fas fa-calendar-check mr-2"></i> Booking Sekarang
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<div id="availabilityModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full md:w-3/4">
    <div class="flex justify-between items-center mb-4 border-b pb-2">
      <h3 class="text-xl font-bold text-gray-800">Cek Ketersediaan Penitipan</h3>
      <button id="closeAvailabilityModal" class="text-gray-500 hover:text-gray-700 focus:outline-none text-xl">
        &times;
      </button>
    </div>
    <div class="space-y-4">
      <div class="flex items-center justify-between mb-4">
        <button id="prevMonthBtn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-lg">&lt;</button>
        <h4 id="currentMonthYear" class="text-lg font-semibold"></h4>
        <button id="nextMonthBtn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-lg">&gt;</button>
      </div>
      <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center">
        <div class="font-bold text-sm text-gray-600">Min</div>
        <div class="font-bold text-sm text-gray-600">Sen</div>
        <div class="font-bold text-sm text-gray-600">Sel</div>
        <div class="font-bold text-sm text-gray-600">Rab</div>
        <div class="font-bold text-sm text-gray-600">Kam</div>
        <div class="font-bold text-sm text-gray-600">Jum</div>
        <div class="font-bold text-sm text-gray-600">Sab</div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
{% block scriptsheet %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/id.js"></script>

<script>
  // Logika form
  const serviceTypeSelect = document.getElementById('id_tipe_layanan');
  const serviceSelect = document.getElementById('id_layanan');
  const durasiInput = document.getElementById('id_durasi');
  const layanan = {{ layanan|safe }};

  function handleServiceTypeChange(selectedType) {
    serviceSelect.innerHTML = '<option value="" disabled selected>-- Pilih Layanan --</option>';
    serviceSelect.disabled = false;
    if (selectedType === 'sitting') {
      durasiInput.disabled = false;
      durasiInput.required = true;
    } else {
      durasiInput.disabled = true;
      durasiInput.required = false;
      durasiInput.value = '';
    }
    if (selectedType && layanan[selectedType]) {
      layanan[selectedType].forEach(function (item) {
        if (item.id && item.nama_layanan) {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.nama_layanan + ' (Rp. ' + item.harga + ')';
          serviceSelect.appendChild(option);
        }
      });
    } else {
      serviceSelect.disabled = true;
    }
  }

  serviceTypeSelect.addEventListener('change', function () {
    handleServiceTypeChange(this.value);
  });
  
  // Auto-select based on parameters from context
  document.addEventListener('DOMContentLoaded', function () {
    const autoTipe = "{{ auto_tipe }}";
    const autoId = "{{ auto_id }}";

    if (autoTipe && autoId) {
      serviceTypeSelect.value = autoTipe;
      handleServiceTypeChange(autoTipe);
      setTimeout(() => {
        const options = serviceSelect.querySelectorAll('option');
        for (let i = 0; i < options.length; i++) {
          if (options[i].value == autoId) {
            serviceSelect.value = autoId;
            break;
          }
        }
      }, 100);
    }
  });

  const openBtn = document.getElementById("openTerms");
  const modal = document.getElementById("termsModal");
  const closeBtn = document.getElementById("closeTerms");

  openBtn.addEventListener("click", (e) => {
    e.preventDefault();
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  });

  closeBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
    document.body.style.overflow = "auto";
  });

  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.add("hidden");
      document.body.style.overflow = "auto";
    }
  });
</script>
<script>
  // Logika Flatpickr dan pembatasan tanggal
  const bookingDateInput = document.getElementById('id_tanggal');
  const dateErrorSpan = document.getElementById('date-error');

  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);

  flatpickr(bookingDateInput, {
    enableTime: true,
    noCalendar: false,
    dateFormat: "Y-m-d H:i",
    minDate: "today",
    maxDate: lastDayOfMonth,

    disable: [
      function (date) {
        return date.getDay() === 0 || date.getDay() === 6;
      },
    ],

    minTime: "08:00",
    maxTime: "17:00",
    
    locale: "id",
  });

  bookingDateInput.addEventListener('change', function() {
    const selectedDateTime = new Date(this.value);
    const day = selectedDateTime.getDay();
    const hours = selectedDateTime.getHours();

    const isWorkingDay = day >= 1 && day <= 5;
    const isWorkingHours = hours >= 8 && hours < 17;

    if (!isWorkingDay || !isWorkingHours) {
      dateErrorSpan.textContent = 'Waktu booking hanya tersedia pada hari kerja (Senin-Jumat) dari jam 8 pagi sampai 5 sore.';
      dateErrorSpan.classList.remove('hidden');
      this.value = '';
    } else {
      dateErrorSpan.textContent = '';
      dateErrorSpan.classList.add('hidden');
    }
  });
</script>
<script>
  // Logika pengecekan kapasitas dinamis
  document.addEventListener('DOMContentLoaded', function() {
    const serviceTypeSelect = document.getElementById('id_tipe_layanan');
    const serviceSelect = document.getElementById('id_layanan');
    const tanggalInput = document.getElementById('id_tanggal');
    const durasiInput = document.getElementById('id_durasi');
    const kapasitasInfo = document.getElementById('kapasitas-info');
    const kapasitasContainer = document.getElementById('kapasitas-container');
    const bookingForm = document.getElementById('bookingForm');
    const openCalendarBtn = document.getElementById('openCalendarBtn');
    const availabilityModal = document.getElementById('availabilityModal');
    const closeAvailabilityModal = document.getElementById('closeAvailabilityModal');
    const calendarGrid = document.getElementById('calendarGrid');
    const currentMonthYear = document.getElementById('currentMonthYear');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    
    let currentDate = new Date();

    // Fungsi untuk memperbarui info kapasitas
    function updateKapasitasInfo() {
      const tipe = serviceTypeSelect.value;
      const layananId = serviceSelect.value;
      const tanggal = tanggalInput.value;
      const durasi = durasiInput.value;

      if (tipe !== 'sitting' || !layananId || !tanggal || !durasi || durasi <= 0) {
        kapasitasContainer.classList.add('hidden');
        bookingForm.classList.remove('pointer-events-none', 'opacity-50');
        return;
      }

      kapasitasInfo.innerHTML = '<span class="text-gray-500">Memeriksa ketersediaan...</span>';
      kapasitasContainer.classList.remove('hidden');
      bookingForm.classList.add('pointer-events-none', 'opacity-50');

      fetch(`/booking/get-kapasitas/?tanggal=${tanggal}&layanan_id=${layananId}&durasi=${durasi}`)
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Terjadi kesalahan jaringan.'); });
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            kapasitasInfo.innerHTML = `<span class="text-red-500">Error: ${data.error}</span>`;
            bookingForm.classList.add('pointer-events-none', 'opacity-50');
          } else if (data.kapasitas_cukup === false) {
            kapasitasInfo.innerHTML = `<span class="text-red-500">${data.pesan}</span>`;
            bookingForm.classList.add('pointer-events-none', 'opacity-50');
          } else {
            const kapasitas = data.kapasitas_tersedia;
            kapasitasInfo.innerHTML = `<span class="text-green-500">Kapasitas Tersedia: ${kapasitas} slot</span>`;
            bookingForm.classList.remove('pointer-events-none', 'opacity-50');
          }
        })
        .catch(error => {
          console.error('Error fetching capacity:', error);
          kapasitasInfo.innerHTML = `<span class="text-red-500">Terjadi kesalahan saat memeriksa kapasitas.</span>`;
          bookingForm.classList.add('pointer-events-none', 'opacity-50');
        });
    }

    // Fungsi untuk memuat data dan merender kalender
    function renderCalendar(year, month) {
      const today = new Date();
      const firstDayOfMonth = new Date(year, month, 1);
      const lastDayOfMonth = new Date(year, month + 1, 0);
      const startDayOfWeek = firstDayOfMonth.getDay();

      currentMonthYear.textContent = `${firstDayOfMonth.toLocaleString('id-ID', { month: 'long' })} ${year}`;
      
      const weekdays = calendarGrid.querySelectorAll('div:not(.day)');
      while (calendarGrid.childElementCount > weekdays.length) {
        calendarGrid.removeChild(calendarGrid.lastChild);
      }

      for (let i = 0; i < startDayOfWeek; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.classList.add('p-2');
        calendarGrid.appendChild(emptyDiv);
      }

      for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('p-2', 'rounded-lg', 'font-medium', 'text-gray-700', 'cursor-pointer', 'day');
        dayDiv.textContent = day;

        const date = new Date(year, month, day);

        if (date.getDay() === 0 || date.getDay() === 6 || date < today) {
          dayDiv.classList.remove('cursor-pointer', 'hover:bg-gray-200');
          dayDiv.classList.add('text-gray-400', 'line-through');
        } else {
          dayDiv.classList.add('hover:bg-gray-200');
        }

        const dateString = date.toISOString().split('T')[0];
        dayDiv.dataset.date = dateString;
        calendarGrid.appendChild(dayDiv);
      }

      // Ambil data kapasitas dari API untuk bulan ini
      const layananId = serviceSelect.value;
      fetch(`/booking/get-kapasitas/?tanggal=${firstDayOfMonth.toISOString().split('T')[0]}&bulan=${true}&layanan_id=${layananId}`)
        .then(response => response.json())
        .then(data => {
          calendarGrid.querySelectorAll('.day').forEach(dayDiv => {
            const date = dayDiv.dataset.date;
            if (data.kapasitas_bulan[date] !== undefined) {
              const kapasitas = data.kapasitas_bulan[date];
              const slotSpan = document.createElement('span');
              slotSpan.classList.add('text-xs', 'block', 'mt-1', 'font-normal');
              if (kapasitas > 0) {
                slotSpan.textContent = `${kapasitas} slot`;
                slotSpan.classList.add('text-green-600');
              } else {
                slotSpan.textContent = 'Penuh';
                slotSpan.classList.add('text-red-600');
                dayDiv.classList.remove('cursor-pointer', 'hover:bg-gray-200');
                dayDiv.classList.add('text-gray-400', 'line-through');
              }
              dayDiv.appendChild(slotSpan);
            }
          });
        });
    }

    // Event listeners untuk navigasi kalender
    prevMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    nextMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    // Event listener untuk membuka modal
    openCalendarBtn.addEventListener('click', () => {
      if (serviceTypeSelect.value === 'sitting' && serviceSelect.value) {
        availabilityModal.classList.remove('hidden');
        document.body.style.overflow = "hidden";
        currentDate = new Date();
        renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
      } else {
        alert('Mohon pilih Tipe Layanan dan Layanan Penitipan terlebih dahulu.');
      }
    });

    // Event listener untuk menutup modal
    closeAvailabilityModal.addEventListener('click', () => {
      availabilityModal.classList.add('hidden');
      document.body.style.overflow = "auto";
    });

    serviceTypeSelect.addEventListener('change', updateKapasitasInfo);
    serviceSelect.addEventListener('change', updateKapasitasInfo);
    tanggalInput.addEventListener('change', updateKapasitasInfo);
    durasiInput.addEventListener('input', updateKapasitasInfo);

    if (serviceTypeSelect.value && serviceSelect.value && tanggalInput.value) {
      updateKapasitasInfo();
    }
  });

</script>
{% endblock scriptsheet %}